# Service 服务发现与负载均衡







**检查Kubernetes API服务器服务**：首先，确保Kubernetes集群中存在名为"kubernetes"的Service，并且它是默认命名空间中的Service。您可以使用以下命令来列出Services并查找"kubernetes"：

```
kubectl get svc -n default
```

如果正确配置，您应该能够看到名为"kubernetes"的Service。

![image-20230928112215114](/Users/shukzhang/Library/Application Support/typora-user-images/image-20230928112215114.png)

**检查CoreDNS或kube-dns**：在Kubernetes集群中，通常使用CoreDNS或kube-dns来提供DNS服务。您需要确保DNS服务正常运行，并且可以解析"kubernetes.default"。检查DNS Pod的运行状态：

```
kubectl get pods -n kube-system | grep dns
```

您应该能够看到DNS Pod的状态为"Running"。如果Pod出现问题，请检查相关日志以查找问题所在。

![image-20230928112238933](/Users/shukzhang/Library/Application Support/typora-user-images/image-20230928112238933.png)



**检查DNS配置**：确保DNS配置正确。如果您使用CoreDNS，检查ConfigMap以查看配置是否包括"kubernetes.default"的正确设置。您可以使用以下命令来查看CoreDNS的配置：

```
kubectl get configmap coredns -n kube-system -o yaml
```

如果您使用kube-dns，您可以查看kube-dns的配置，但它通常不需要手动配置。

![image-20230928112301717](/Users/shukzhang/Library/Application Support/typora-user-images/image-20230928112301717.png)

以下是CoreDNS ConfigMap 中的相关部分：

```
yamlCopy code
kubernetes cluster.local in-addr.arpa ip6.arpa {
   pods insecure
   fallthrough in-addr.arpa ip6.arpa
   ttl 30
}
```

这段配置指定了CoreDNS 如何处理与Kubernetes集群相关的DNS查询。它告诉CoreDNS 使用 "cluster.local" 域名来解析Kubernetes服务和Pod的DNS查询。

如果您的Kubernetes集群的配置和网络环境没有其他问题，那么这个配置是正确的，应该允许CoreDNS 正确解析 "kubernetes.default" 和其他与Kubernetes相关的DNS查询。

请确保您的CoreDNS Pod 正在运行，并且没有<u>其他网络或配置问题</u>导致DNS查询失败。如果仍然存在DNS解析问题，可能需要进一步检查网络配置和集群状态以找到问题的原因。



https://www.cnblogs.com/younger5/p/16805279.html

## 访问方式

headless 因为没有ClusterIp,所以不能使用Ip的方式访问，只能使用域名，而且只能在容器内部生效

访问service

[servicename].[namespace].svc.cluster.local

访问单个pod

[podname].[servicename].[namespace].svc.cluster.local

## 3.查找DNS

进入容器，cat /etc/reslove.conf

test-runner-08c9896b： 

```
cat /etc/resolv.conf
search zsk.svc.cluster.local svc.cluster.local cluster.local
nameserver 10.96.0.10
options ndots:5
```

test-runner-66aec007

```
cat /etc/resolv.conf
search zsk.svc.cluster.local svc.cluster.local cluster.local
nameserver 10.96.0.10
options ndots:5
```



 nslookup 能够解析到三个pod

```shell
➜  brightbird git:(master) ✗ kubectl get svc -n zsk
NAME                                   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
sophon-auth-371c71ea003cb20d-service   ClusterIP   None         <none>        8989/TCP   29d
sophon-auth-a34f4921aa3fccdc-service   ClusterIP   None         <none>        8989/TCP   7m32s
sophon-auth-ed58890d003cb20d-service   ClusterIP   None         <none>        8989/TCP   29d
➜  brightbird git:(master) ✗ nslookup sophon-auth-a34f4921aa3fccdc-service.zsk.svc.cluster.local
Server:		127.0.0.53
Address:	127.0.0.53#53

** server can't find sophon-auth-a34f4921aa3fccdc-service.zsk.svc.cluster.local: SERVFAIL
```

